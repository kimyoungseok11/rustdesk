name: macOS Build

on:
    # push:
    #     branches: [master]
    workflow_dispatch:

jobs:
    build-macos:
        runs-on: macos-13 # ðŸ”´ ì¤‘ìš”: macos-14 ì“°ë©´ ABI í„°ì§

        env:
            # â—ï¸í•µì‹¬: ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì „ë¶€ ì°¨ë‹¨
            NO_PKG_CONFIG: '1'
            NO_PKG_CONFIG_libyuv: '1'
            NO_PKG_CONFIG_libvpx: '1'
            NO_PKG_CONFIG_aom: '1'
            NO_PKG_CONFIG_vmaf: '1'
            NO_PKG_CONFIG_opus: '1'

            MACOSX_DEPLOYMENT_TARGET: '11.0'
            RUSTFLAGS: '-C link-arg=-Wl,-dead_strip'

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: aarch64-apple-darwin

            - name: Rust cache
              uses: Swatinem/rust-cache@v2

            - name: Build rustdesk (core)
              run: |
                  cargo build --release --bin rustdesk

            - name: Create .app bundle
              run: |
                  APP_NAME=RustDesk.app
                  BIN=target/release/rustdesk

                  mkdir -p "$APP_NAME/Contents/MacOS"
                  mkdir -p "$APP_NAME/Contents/Resources"

                  cp "$BIN" "$APP_NAME/Contents/MacOS/RustDesk"

                  cat > "$APP_NAME/Contents/Info.plist" <<EOF
                  <?xml version="1.0" encoding="UTF-8"?>
                  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
                  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                  <plist version="1.0">
                  <dict>
                    <key>CFBundleName</key>
                    <string>RustDesk</string>
                    <key>CFBundleExecutable</key>
                    <string>RustDesk</string>
                    <key>CFBundleIdentifier</key>
                    <string>com.example.rustdesk</string>
                    <key>CFBundleVersion</key>
                    <string>1.0.0</string>
                    <key>CFBundlePackageType</key>
                    <string>APPL</string>
                    <key>LSMinimumSystemVersion</key>
                    <string>11.0</string>
                  </dict>
                  </plist>
                  EOF

            - name: Zip app
              run: |
                  zip -r RustDesk-macOS.zip RustDesk.app

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: RustDesk-macOS
                  path: RustDesk-macOS.zip
