name: Windows Build

on:
    # push:
    #     branches: [master]
    workflow_dispatch:

jobs:
    build-windows:
        runs-on: windows-latest

        steps:
            # 1. Checkout (submodules í¬í•¨)
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            # 2. Rust
            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            # 3. Flutter
            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable

            - name: Enable Windows Desktop
              run: flutter config --enable-windows-desktop

            # ðŸ”¥ í•µì‹¬ 1: vcpkg (static triplet)
            - name: Setup vcpkg (static)
              shell: pwsh
              run: |
                  if (-Not (Test-Path "C:\vcpkg")) {
                    git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
                  }
                  echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
                  echo "VCPKG_DEFAULT_TRIPLET=x64-windows-static" >> $env:GITHUB_ENV
                  C:\vcpkg\vcpkg.exe install --triplet x64-windows-static

            # ðŸ”¥ í•µì‹¬ 2: scrap / opus / vpx build.rsê°€ envë¥¼ í™•ì‹¤ížˆ ë³´ê²Œ í•¨
            - name: Build Rust Core
              env:
                  VCPKG_ROOT: C:\vcpkg
                  VCPKG_DEFAULT_TRIPLET: x64-windows-static
              run: cargo build --release

            # 6. Flutter Windows
            - name: Build Windows App
              working-directory: flutter
              run: flutter build windows

            # 7. Upload
            - name: Upload Windows Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-windows
                  path: flutter/build/windows/runner/Release/
