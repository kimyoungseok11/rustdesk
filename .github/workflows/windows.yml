name: build-windows

on:
    # push:
    #     branches: [master]
    workflow_dispatch:

jobs:
    build-windows:
        runs-on: windows-latest

        env:
            RUST_BACKTRACE: 1
            VCPKG_ROOT: C:\vcpkg
            VCPKG_DEFAULT_TRIPLET: x64-windows-static

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            # ---------- vcpkg ----------
            - name: Setup vcpkg
              run: |
                  if (!(Test-Path C:\vcpkg)) {
                    git clone https://github.com/microsoft/vcpkg C:\vcpkg
                  }
                  cd C:\vcpkg
                  .\bootstrap-vcpkg.bat -disableMetrics

                  .\vcpkg install libyuv:x64-windows-static
                  .\vcpkg install libvpx:x64-windows-static
                  .\vcpkg install opus:x64-windows-static

            # ---------- Rust ----------
            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            # ---------- Flutter ----------
            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable

            # ---------- Rust core ----------
            - name: Build Rust Core
              run: cargo build --release

            # ---------- Flutter Windows ----------
            - name: Build Windows App
              run: |
                  cd flutter
                  flutter pub get
                  flutter build windows --release

            # ---------- Artifact ----------
            - name: Upload Windows Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-windows
                  path: flutter/build/windows/runner/Release
