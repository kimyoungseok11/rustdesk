name: build-macos

on:
    # push:
    #     branches: [master]
    workflow_dispatch:

jobs:
    build-macos:
        runs-on: macos-14

        env:
            RUST_BACKTRACE: 1

            # üî• Ïù¥ Ï§ÑÏù¥ ÏµúÏ¢Ö Ìï¥Îãµ
            CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER: clang++

            # C/C++ crate ÎπåÎìúÏö©
            CC: clang
            CXX: clang++

        steps:
            # ----------------------------------
            # 1. Checkout
            # ----------------------------------
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            # ----------------------------------
            # 2. Native dependencies
            # ----------------------------------
            - name: Install native dependencies
              run: |
                  brew update
                  brew install cmake ninja opus libvpx aom

                  # libyuv ÏßÅÏ†ë ÎπåÎìú
                  git clone https://chromium.googlesource.com/libyuv/libyuv
                  cd libyuv

                  INSTALL_DIR="/opt/homebrew/Cellar/libyuv/0.0.0"
                  mkdir -p build
                  cd build

                  cmake .. \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_INSTALL_PREFIX="${INSTALL_DIR}" \
                    -DBUILD_SHARED_LIBS=OFF \
                    -DCMAKE_C_COMPILER=clang \
                    -DCMAKE_CXX_COMPILER=clang++

                  cmake --build .
                  sudo cmake --install .

            # ----------------------------------
            # 3. Rust
            # ----------------------------------
            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: aarch64-apple-darwin

            # ----------------------------------
            # 4. Flutter
            # ----------------------------------
            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable

            - name: Flutter doctor
              run: flutter doctor -v

            # ----------------------------------
            # 5. Rust core build
            # ----------------------------------
            - name: Build Rust core
              run: cargo build --release

            # ----------------------------------
            # 6. Flutter macOS build
            # ----------------------------------
            - name: Build macOS App
              run: |
                  cd flutter
                  flutter pub get
                  flutter build macos --release

            # ----------------------------------
            # 7. Artifact
            # ----------------------------------
            - name: Upload macOS Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-macos
                  path: flutter/build/macos/Build/Products/Release
