name: Build macOS

on:
    # push:
    #   branches: [ main, master ]
    # pull_request:
    #   branches: [ main, master ]
    workflow_dispatch:

jobs:
    build-macos:
        runs-on: macos-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Install Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable

            - name: Install dependencies
              run: |
                  brew install cmake pkg-config nasm yasm opus vpx libyuv

            - name: Verify opus installation
              run: |
                  brew list opus
                  pkg-config --modversion opus
                  ls -la /opt/homebrew/Cellar/opus/ || ls -la /usr/local/Cellar/opus/

            - name: Set PKG_CONFIG_PATH
              run: |
                  if [ -d "/opt/homebrew" ]; then
                    echo "PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig:/opt/homebrew/opt/opus/lib/pkgconfig" >> $GITHUB_ENV
                    echo "OPUS_STATIC=1" >> $GITHUB_ENV
                  else
                    echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/local/opt/opus/lib/pkgconfig" >> $GITHUB_ENV
                    echo "OPUS_STATIC=1" >> $GITHUB_ENV
                  fi

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: '3.24.3'
                  channel: 'stable'

            - name: Setup Flutter
              run: |
                  flutter config --enable-macos-desktop
                  flutter doctor -v

            - name: Install Rust targets
              run: |
                  rustup target add x86_64-apple-darwin
                  rustup target add aarch64-apple-darwin

            - name: Cache Cargo
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Build RustDesk
              env:
                  PKG_CONFIG_PATH: ${{ env.PKG_CONFIG_PATH }}
                  OPUS_STATIC: '1'
              run: |
                  python3 build.py --flutter

            - name: List build outputs
              if: always()
              run: |
                  echo "=== Build outputs ==="
                  find target/release -type f -name "rustdesk*" || true
                  ls -lah target/release/bundle/osx/ 2>/dev/null || echo "No bundle directory found"

            - name: Create release directory
              run: |
                  mkdir -p release_output
                  if [ -d "target/release/bundle/osx" ]; then
                    cp -r target/release/bundle/osx/* release_output/ || true
                  fi
                  if [ -f "target/release/rustdesk" ]; then
                    cp target/release/rustdesk release_output/ || true
                  fi
                  ls -lah release_output/

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-macos-${{ github.sha }}
                  path: release_output/
                  if-no-files-found: warn

            - name: Upload Release Asset
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  files: release_output/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
