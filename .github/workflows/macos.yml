name: macOS Build

on:
    workflow_dispatch:
    # push:
    #     branches: [master]

jobs:
    build-macos:
        runs-on: macos-14 # âœ… ì´ì œ ì´ê±° ë§ê³  ì„ íƒì§€ ì—†ìŒ

        env:
            # ðŸ”´ system lib ì „ë¶€ ì°¨ë‹¨
            NO_PKG_CONFIG: '1'
            NO_PKG_CONFIG_libyuv: '1'
            NO_PKG_CONFIG_libvpx: '1'
            NO_PKG_CONFIG_aom: '1'
            NO_PKG_CONFIG_vmaf: '1'
            NO_PKG_CONFIG_opus: '1'

            # â­ scrap VMAF ì™„ì „ ì°¨ë‹¨ (ê°€ìž¥ ì¤‘ìš”)
            SCRAP_DISABLE_VMAF: '1'

            # ðŸ”§ macOS ABI ì •ë ¬
            MACOSX_DEPLOYMENT_TARGET: '14.0'
            SDKROOT: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk

            RUSTFLAGS: '-C link-arg=-Wl,-dead_strip'

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: aarch64-apple-darwin

            - name: Rust cache
              uses: Swatinem/rust-cache@v2

            - name: Build rustdesk
              run: |
                  cargo build --release --bin rustdesk

            - name: Create .app bundle
              run: |
                  APP=RustDesk.app
                  BIN=target/release/rustdesk

                  mkdir -p "$APP/Contents/MacOS"
                  mkdir -p "$APP/Contents/Resources"

                  cp "$BIN" "$APP/Contents/MacOS/RustDesk"

                  cat > "$APP/Contents/Info.plist" <<EOF
                  <?xml version="1.0" encoding="UTF-8"?>
                  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
                  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                  <plist version="1.0">
                  <dict>
                    <key>CFBundleExecutable</key>
                    <string>RustDesk</string>
                    <key>CFBundleIdentifier</key>
                    <string>com.example.rustdesk</string>
                    <key>CFBundleName</key>
                    <string>RustDesk</string>
                    <key>CFBundleVersion</key>
                    <string>1.4.5</string>
                    <key>CFBundlePackageType</key>
                    <string>APPL</string>
                    <key>LSMinimumSystemVersion</key>
                    <string>14.0</string>
                  </dict>
                  </plist>
                  EOF

            - name: Zip app
              run: |
                  zip -r RustDesk-macOS.zip RustDesk.app

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: RustDesk-macOS
                  path: RustDesk-macOS.zip
