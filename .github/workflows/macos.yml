name: Build RustDesk macOS

on:
    # push:
    #     branches: [main, master]
    # pull_request:
    #     branches: [main, master]
    workflow_dispatch:

jobs:
    build-macos:
        runs-on: macos-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Install Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable

            - name: Install dependencies
              run: |
                  brew install llvm cmake ninja nasm yasm pkg-config

            - name: Setup LLVM environment
              run: |
                  echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV
                  echo "LLVM_HOME=$(brew --prefix llvm)" >> $GITHUB_ENV
                  echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

            - name: Install vcpkg
              run: |
                  cd /Users/runner
                  git clone https://github.com/microsoft/vcpkg
                  cd vcpkg
                  ./bootstrap-vcpkg.sh
                  echo "VCPKG_ROOT=/Users/runner/vcpkg" >> $GITHUB_ENV

            - name: Install vcpkg dependencies
              run: |
                  cd ${{ github.workspace }}
                  /Users/runner/vcpkg/vcpkg install

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: '3.24.3'
                  channel: 'stable'

            - name: Setup Flutter
              run: |
                  flutter config --enable-macos-desktop
                  flutter doctor -v

            - name: Install Rust targets
              run: |
                  rustup target add x86_64-apple-darwin
                  rustup target add aarch64-apple-darwin

            - name: Cache Cargo
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache vcpkg
              uses: actions/cache@v3
              with:
                  path: |
                      /Users/runner/vcpkg
                      vcpkg_installed
                  key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}

            - name: Set environment variables
              run: |
                  echo "MACOSX_DEPLOYMENT_TARGET=10.14" >> $GITHUB_ENV
                  echo "VCPKG_ROOT=/Users/runner/vcpkg" >> $GITHUB_ENV
                  echo "CARGO_PROFILE_RELEASE_BUILD_OVERRIDE_DEBUG=true" >> $GITHUB_ENV

            - name: Build RustDesk
              env:
                  VCPKG_ROOT: /Users/runner/vcpkg
                  MACOSX_DEPLOYMENT_TARGET: '10.14'
                  LIBCLANG_PATH: ${{ env.LIBCLANG_PATH }}
              run: |
                  python3 build.py --flutter --hwcodec

            - name: List build outputs
              if: always()
              run: |
                  echo "=== Searching for build outputs ==="
                  find target -name "*.app" -o -name "*.dmg" || true
                  echo "=== Contents of target/release ==="
                  ls -la target/release/ || true

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-macos
                  path: |
                      target/release/bundle/osx/*.dmg
                      target/release/bundle/osx/*.app
                  if-no-files-found: warn

            - name: Upload Release Asset
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      target/release/bundle/osx/*.dmg
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
