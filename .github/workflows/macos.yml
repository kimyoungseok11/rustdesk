name: Build RustDesk macOS

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_dispatch:

jobs:
    build-macos:
        runs-on: macos-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Install Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable

            - name: Install dependencies
              run: |
                  brew install cmake pkg-config nasm yasm opus libvpx

            - name: Verify libvpx installation
              run: |
                  echo "=== libvpx location ==="
                  brew list libvpx | grep -E '\.(a|dylib)$' || true
                  echo ""
                  echo "=== pkg-config check ==="
                  pkg-config --libs --cflags vpx || true
                  echo ""
                  echo "=== Homebrew prefix ==="
                  brew --prefix libvpx

            - name: Install vcpkg
              run: |
                  cd /Users/runner
                  git clone https://github.com/microsoft/vcpkg
                  cd vcpkg
                  ./bootstrap-vcpkg.sh
                  echo "VCPKG_ROOT=/Users/runner/vcpkg" >> $GITHUB_ENV

            - name: Install vcpkg dependencies
              run: |
                  cd ${{ github.workspace }}
                  /Users/runner/vcpkg/vcpkg install

            - name: Create libyuv symlink
              run: |
                  sudo mkdir -p /opt/homebrew/Cellar/libyuv

                  ARCH=$(uname -m)
                  if [ -d "vcpkg_installed/${ARCH}-osx" ]; then
                    VCPKG_INSTALLED="$PWD/vcpkg_installed/${ARCH}-osx"
                  elif [ -d "vcpkg_installed/arm64-osx" ]; then
                    VCPKG_INSTALLED="$PWD/vcpkg_installed/arm64-osx"
                  elif [ -d "vcpkg_installed/x64-osx" ]; then
                    VCPKG_INSTALLED="$PWD/vcpkg_installed/x64-osx"
                  fi

                  if [ -n "$VCPKG_INSTALLED" ] && [ -d "$VCPKG_INSTALLED" ]; then
                    echo "Found vcpkg installation at: $VCPKG_INSTALLED"
                    sudo ln -sf $VCPKG_INSTALLED/include /opt/homebrew/Cellar/libyuv/include
                    sudo ln -sf $VCPKG_INSTALLED/lib /opt/homebrew/Cellar/libyuv/lib
                  fi

            - name: Set environment variables
              run: |
                  BREW_PREFIX=$(brew --prefix)
                  ARCH=$(uname -m)
                  VCPKG_INSTALLED="$PWD/vcpkg_installed/${ARCH}-osx"

                  if [ ! -d "$VCPKG_INSTALLED" ]; then
                    if [ -d "vcpkg_installed/arm64-osx" ]; then
                      VCPKG_INSTALLED="$PWD/vcpkg_installed/arm64-osx"
                    elif [ -d "vcpkg_installed/x64-osx" ]; then
                      VCPKG_INSTALLED="$PWD/vcpkg_installed/x64-osx"
                    fi
                  fi

                  # PKG_CONFIG_PATH
                  echo "PKG_CONFIG_PATH=${BREW_PREFIX}/lib/pkgconfig:${BREW_PREFIX}/opt/opus/lib/pkgconfig:${BREW_PREFIX}/opt/libvpx/lib/pkgconfig:${VCPKG_INSTALLED}/lib/pkgconfig" >> $GITHUB_ENV

                  # RUSTFLAGS에 링커 경로 추가
                  echo "RUSTFLAGS=-L ${BREW_PREFIX}/lib -L ${BREW_PREFIX}/opt/libvpx/lib -L ${BREW_PREFIX}/opt/opus/lib -L ${VCPKG_INSTALLED}/lib" >> $GITHUB_ENV

                  echo "OPUS_STATIC=1" >> $GITHUB_ENV
                  echo "CPATH=${BREW_PREFIX}/include:${VCPKG_INSTALLED}/include" >> $GITHUB_ENV
                  echo "LIBRARY_PATH=${BREW_PREFIX}/lib:${BREW_PREFIX}/opt/libvpx/lib:${VCPKG_INSTALLED}/lib" >> $GITHUB_ENV
                  echo "VCPKG_ROOT=/Users/runner/vcpkg" >> $GITHUB_ENV

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: '3.24.3'
                  channel: 'stable'

            - name: Setup Flutter
              run: |
                  flutter config --enable-macos-desktop
                  flutter doctor -v

            - name: Cache Cargo
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache vcpkg
              uses: actions/cache@v3
              with:
                  path: |
                      /Users/runner/vcpkg
                      vcpkg_installed
                  key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}

            - name: Build RustDesk
              env:
                  PKG_CONFIG_PATH: ${{ env.PKG_CONFIG_PATH }}
                  RUSTFLAGS: ${{ env.RUSTFLAGS }}
                  OPUS_STATIC: '1'
                  CPATH: ${{ env.CPATH }}
                  LIBRARY_PATH: ${{ env.LIBRARY_PATH }}
                  VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
              run: |
                  echo "=== Environment check ==="
                  echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
                  echo "RUSTFLAGS: $RUSTFLAGS"
                  echo "LIBRARY_PATH: $LIBRARY_PATH"
                  echo ""
                  python3 build.py --flutter

            - name: List build outputs
              if: always()
              run: |
                  echo "=== Searching for build outputs ==="
                  find target/release -type f \( -name "rustdesk*" -o -name "*.app" -o -name "*.dmg" \) 2>/dev/null || true
                  echo ""
                  echo "=== Bundle directory contents ==="
                  ls -lRh target/release/bundle/ 2>/dev/null || echo "No bundle directory found"

            - name: Create release directory
              run: |
                  mkdir -p release_output

                  if [ -d "target/release/bundle/osx" ]; then
                    cp -r target/release/bundle/osx/* release_output/ 2>/dev/null || true
                  fi

                  find target/release -name "*.dmg" -exec cp {} release_output/ \; 2>/dev/null || true

                  if [ -f "target/release/rustdesk" ]; then
                    cp target/release/rustdesk release_output/ 2>/dev/null || true
                  fi

                  echo "=== Release output contents ==="
                  ls -lah release_output/

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-macos-${{ github.sha }}
                  path: release_output/
                  if-no-files-found: warn
