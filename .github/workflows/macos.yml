name: macOS Build

on:
    workflow_dispatch:
    # push:
    #     branches: [master]

jobs:
    build-macos:
        runs-on: macos-14

        env:
            # ðŸ”´ ëª¨ë“  ì™¸ë¶€ codec ì°¨ë‹¨
            NO_PKG_CONFIG: '1'
            NO_PKG_CONFIG_libyuv: '1'
            NO_PKG_CONFIG_libvpx: '1'
            NO_PKG_CONFIG_aom: '1'
            NO_PKG_CONFIG_vmaf: '1'
            NO_PKG_CONFIG_opus: '1'

            # â­ í•µì‹¬: scrap / opus / audio ì™„ì „ ì°¨ë‹¨
            SCRAP_DISABLE_VMAF: '1'
            DISABLE_AUDIO: '1'

            MACOSX_DEPLOYMENT_TARGET: '14.0'

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: aarch64-apple-darwin

            - uses: Swatinem/rust-cache@v2

            - name: Build rustdesk (no audio)
              run: |
                  cargo build --release \
                    --bin rustdesk \
                    --no-default-features \
                    --features flutter,ipc

            - name: Bundle app
              run: |
                  APP=RustDesk.app
                  BIN=target/release/rustdesk

                  mkdir -p "$APP/Contents/MacOS"
                  mkdir -p "$APP/Contents/Resources"

                  cp "$BIN" "$APP/Contents/MacOS/RustDesk"

                  cat > "$APP/Contents/Info.plist" <<EOF
                  <?xml version="1.0" encoding="UTF-8"?>
                  <plist version="1.0">
                  <dict>
                    <key>CFBundleExecutable</key>
                    <string>RustDesk</string>
                    <key>CFBundleIdentifier</key>
                    <string>com.rustdesk.app</string>
                    <key>CFBundleName</key>
                    <string>RustDesk</string>
                    <key>LSMinimumSystemVersion</key>
                    <string>14.0</string>
                  </dict>
                  </plist>
                  EOF

            - name: Zip
              run: zip -r RustDesk-macOS.zip RustDesk.app

            - uses: actions/upload-artifact@v4
              with:
                  name: RustDesk-macOS
                  path: RustDesk-macOS.zip
