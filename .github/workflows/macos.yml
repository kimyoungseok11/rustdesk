name: build-macos

on:
    # push:
    #     branches: [master]
    workflow_dispatch:

jobs:
    build-macos:
        runs-on: macos-14

        env:
            RUST_BACKTRACE: 1

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            # ---------- libyuv 직접 빌드 ----------
            - name: Build libyuv
              run: |
                  brew install cmake ninja
                  git clone https://chromium.googlesource.com/libyuv/libyuv
                  cd libyuv

                  INSTALL_DIR="/opt/homebrew/Cellar/libyuv/0.0.0"
                  mkdir -p build
                  cd build

                  cmake .. \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_INSTALL_PREFIX="${INSTALL_DIR}" \
                    -DBUILD_SHARED_LIBS=OFF

                  cmake --build .
                  sudo cmake --install .

            # ---------- Rust ----------
            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            # ---------- Flutter ----------
            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable

            # ---------- Rust core ----------
            - name: Build Rust Core
              run: cargo build --release

            # ---------- Flutter macOS ----------
            - name: Build macOS App
              run: |
                  cd flutter
                  flutter pub get
                  flutter build macos --release

            # ---------- Artifact ----------
            - name: Upload macOS Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-macos
                  path: flutter/build/macos/Build/Products/Release
