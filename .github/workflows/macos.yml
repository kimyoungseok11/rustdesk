name: macOS Build

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-macos:
        runs-on: macos-latest

        steps:
            - name: Checkout repository (with submodules)
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Rust toolchain
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Install build dependencies
              run: |
                  brew update
                  brew install cmake nasm yasm opus pkg-config

            - name: Configure opus path
              run: |
                  echo "OPUS_DIR=$(brew --prefix opus)" >> $GITHUB_ENV
                  echo "PKG_CONFIG_PATH=$(brew --prefix opus)/lib/pkgconfig" >> $GITHUB_ENV

            - name: Build RustDesk client
              run: |
                  cargo build --release -p rustdesk

            - name: Prepare artifact
              run: |
                  mkdir -p artifacts
                  cp target/release/rustdesk artifacts/rustdesk-macos

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: rustdesk-macos
                  path: artifacts/rustdesk-macos

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: artifacts/rustdesk-macos
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOK
